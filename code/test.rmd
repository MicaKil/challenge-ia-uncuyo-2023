---
title: "Parte B"
output: html_document
author: "Micaela Del Longo @MicaKil"
---

# Librerías

```{r}
library(dplyr)
library(ggplot2)
library(lattice)
library(caret)
library(randomForest)
library(ROSE)
```

# Carga de Datos

```{r}
data <- read.csv("data/data-tests/arbolado-mza-dataset.csv")
#data$inclinacion_peligrosa <- factor(data$inclinacion_peligrosa)

# remueve columnas innecesarias
data$ultima_modificacion <- NULL
data$area_seccion <- NULL

test_data <- read.csv("data/data-tests/arbolado-mza-dataset-test.csv")
test_data$ultima_modificacion <- NULL
test_data$area_seccion <- NULL
```

# Split

```{r}
# split by 80/20
set.seed(2023)
indeces_train <- caret::createDataPartition(data$inclinacion_peligrosa, p = 0.8, list = FALSE)
train_data <- data[indeces_train, ]
validation_data <- data[-indeces_train, ]

# train_1 <- train_data %>% dplyr::filter(inclinacion_peligrosa == 1) %>% nrow()
# rows_train <- nrow(train_data)
# percent_train <- train_1 / rows_train * 100
# validation_1 <- validation_data %>% dplyr::filter(inclinacion_peligrosa == 1) %>% nrow()
# rows_validation <- nrow(validation_data)
# percent_validation <- validation_1 / rows_validation * 100

# guardar
write.csv(train_data, "data/data-tests/arbolado-mendoza-dataset-train.csv", row.names = FALSE)
write.csv(validation_data, "data/data-tests/arbolado-mendoza-dataset-validation.csv", row.names = FALSE)
```

# Under-sampling

```{r}
data <- ovun.sample(inclinacion_peligrosa ~ ., data = data, method = "under", seed = 2023)$data

# data_inclinacion_peligrosa_0 <- data %>% dplyr::filter(inclinacion_peligrosa == 0)
# data_inclinacion_peligrosa_1 <- data %>% dplyr::filter(inclinacion_peligrosa == 1)
#
# set.seed(2023)
# indeces_inclinacion_peligrosa_0 <- caret::createDataPartition(data_inclinacion_peligrosa_0$inclinacion_peligrosa, p = 0.125, list = FALSE)
# undersampled_data <- data_inclinacion_peligrosa_0[indeces_inclinacion_peligrosa_0, ]
#
# # merge
# balanced_data <- rbind(data_inclinacion_peligrosa_1, undersampled_data)  # bind rows
# balanced_data <- balanced_data[order(balanced_data$id), ]  # ordena por id
```

# Over-sampling and Under-sampling

```{r}
data <- ovun.sample(inclinacion_peligrosa ~ ., data = data, method = "both", seed = 2023)$data

percentage_1 <- data %>% dplyr::filter(inclinacion_peligrosa == 1) %>% nrow() / nrow(data) * 100
```

# Cost Sensitive Learning

```{r}
# class weights
class_distribution <- table(train_data$inclinacion_peligrosa)
class_probability <- class_distribution / sum(class_distribution)

class_weights <- class_distribution[2] / class_distribution

weights <- ifelse(train_data$inclinacion_peligrosa == 1, class_weights[2], class_weights[1])
weights_prob <- ifelse(train_data$inclinacion_peligrosa == 1, class_probability[2], class_probability[1])
```

# Feature Engineering

> In **count encoding** we replace the categories by the count of the observations that show that category in the dataset.
> Similarly, we can replace the category by the **frequency** -or percentage- of observations in the dataset. That is, if
> 10 of our 100 observations show the colour blue, we would replace blue by 10 if doing count encoding, or by 0.1 if
> replacing by the frequency. These techniques capture the representation of each label in a dataset, but the encoding
> may not necessarily be predictive of the outcome.
>
> This approach is heavily used in Kaggle competitions, wherein we replace each label of the categorical variable by
> the count, this is the amount of times each label appears in the dataset. Or the frequency, this is the percentage
> of observations within that category. The two methods are equivalent.

## Peligrosidad Encoding

```{r}
peligrosidad_encoding <- function(data, column, new_column) {
    peligrosidad <- data %>%
        dplyr::group_by(!!sym(column)) %>%
        dplyr::summarize(peligrosa_count = sum(inclinacion_peligrosa == 1), total_count = n()) %>%
        dplyr::mutate({{new_column}} := peligrosa_count / total_count)

    return(peligrosidad)
}

# p <- peligrosidad_encoding(train_data, "especie", "peligrosidad_especie")
# p
```

## Peligrosidad por Especie

```{r}
especies_peligrosas <- peligrosidad_encoding(train_data, "especie", "peligrosidad_especie")

train_data <- train_data %>%
    left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

train_data$especie <- NULL
```

```{r}
test_data <- test_data %>%
	left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

test_data$especie <- NULL
```

```{r}
validation_data <- validation_data %>%
	left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

validation_data$especie <- NULL
```

## Peligrosidad por Diámetro

```{r}
diametro_peligroso <- peligrosidad_encoding(train_data, "diametro_tronco", "peligrosidad_diametro")

train_data <- train_data %>%
    left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

train_data$diametro_tronco <- NULL
```

```{r}
test_data <- test_data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

test_data$diametro_tronco <- NULL
```

```{r}
validation_data <- validation_data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

validation_data$diametro_tronco <- NULL
```

## Peligrosidad por Altura

```{r}
altura_peligrosa <- peligrosidad_encoding(train_data, "altura", "peligrosidad_altura")

train_data <- train_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

train_data$altura <- NULL
```

```{r}
test_data <- test_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

test_data$altura <- NULL
```

```{r}
validation_data <- validation_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

validation_data$altura <- NULL
```

## Peligrosidad por Sección

```{r}
seccion_peligrosa <- peligrosidad_encoding(train_data, "nombre_seccion", "peligrosidad_seccion")

train_data <- train_data %>%
	left_join(seccion_peligrosa %>% select(nombre_seccion, peligrosidad_seccion), by = "nombre_seccion")

train_data$nombre_seccion <- NULL
train_data$seccion <- NULL
```

```{r}
test_data <- test_data %>%
	left_join(seccion_peligrosa %>% select(nombre_seccion, peligrosidad_seccion), by = "nombre_seccion")

test_data$nombre_seccion <- NULL
test_data$seccion <- NULL
```

```{r}
validation_data <- validation_data %>%
	left_join(seccion_peligrosa %>% select(nombre_seccion, peligrosidad_seccion), by = "nombre_seccion")

validation_data$nombre_seccion <- NULL
validation_data$seccion <- NULL
```

# Random Forest

```{r}
train_data$inclinacion_peligrosa <- as.factor(train_data$inclinacion_peligrosa)

formula <- inclinacion_peligrosa ~ circ_tronco_cm + lat + long + peligrosidad_especie + peligrosidad_diametro + peligrosidad_altura + peligrosidad_seccion

rf_model <- randomForest(formula,
                         data = train_data,
                         ntree = 600,
                         #mtry = 3,  # Number of variables randomly sampled at each split. Default values: for classification sqrt(p) and regression p/3
                         classwt = class_probability,
                         importance = TRUE,
                         proximity = TRUE,
                         do.trace = TRUE
                         )
```

```{r}
rf_model
varImpPlot(rf_model)
```

## Predicción

```{r}
predictions <- predict(rf_model, validation_data)
validation_data$inclinacion_peligrosa <- as.factor(validation_data$inclinacion_peligrosa)
confusion_matrix <- confusionMatrix(predictions, validation_data$inclinacion_peligrosa)
confusion_matrix
```

# Random Forest 2

```{r}
train_data$inclinacion_peligrosa <- as.factor(train_data$inclinacion_peligrosa)

#your_data_factorized <- as.data.frame(lapply(train_data, as.factor))  # factorize all columns
ctrl <- trainControl(method = "cv", number = 10, classProbs = TRUE)
formula <- formula(inclinacion_peligrosa ~ .) #circ_tronco_cm + lat + long + peligrosidad_especie + peligrosidad_diametro + peligrosidad_altura + peligrosidad_seccion)

set.seed(2023)
rf_model <- train(formula,
                  data = train_data,
                  method = "rf",
                  trControl = ctrl,
                  metric="ROC",
                  weights = weights_prob)

rf_model
```
