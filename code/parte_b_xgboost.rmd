---
title: "Parte B"
output: html_document
author: "Micaela Del Longo @MicaKil"
---

### Comentario para fede
Uso definición de test y validation de Harpo. sorry :c

# Librerías

```{r}
library(dplyr)
library(ggplot2)
library(lattice)
library(caret)
library(ROSE)
library(xgboost)
library(fastDummies)
```

# Preparación de los Datos

```{r}
data <- read.csv("data/data-parte-b/arbolado-mza-dataset.csv")
data$inclinacion_peligrosa <- factor(data$inclinacion_peligrosa)

data$ultima_modificacion <- NULL
data$area_seccion <- NULL

test_data <- read.csv("data/data-parte-b/arbolado-mza-dataset-test.csv")
test_data$ultima_modificacion <- NULL
test_data$area_seccion <- NULL
```

```{r}
# separar en train y test
set.seed(2023)
validation_index <- createDataPartition(data$inclinacion_peligrosa, p = 0.8, list = FALSE)
train_data <- data[validation_index, ]
validation_data <- data[-validation_index, ]
```

```{r}
class_distribution <- table(train_data$inclinacion_peligrosa)
scale_pos_weight <- class_distribution[2] / class_distribution[1]

class_weights <- 1 / class_distribution
```

## Feature Engineering

```{r}
peligrosidad_encoding <- function(train_data, column, new_column) {
    peligrosidad <- train_data %>%
        dplyr::group_by(!!sym(column)) %>%
        dplyr::summarize(peligrosa_count = sum(inclinacion_peligrosa == 1), total_count = n()) %>%
        dplyr::mutate({{new_column}} := peligrosa_count / total_count)

    return(peligrosidad)
}
```

### Reemplazo de Columna de Sección por Peligrosidad por Sección

```{r}
secciones_peligrosas <- peligrosidad_encoding(train_data, "nombre_seccion", "peligrosidad_seccion")

train_data <- train_data %>%
	left_join(secciones_peligrosas %>% select(nombre_seccion, peligrosidad_seccion), by = "nombre_seccion")

validation_data <- validation_data %>%
	left_join(secciones_peligrosas %>% select(nombre_seccion, peligrosidad_seccion), by = "nombre_seccion")

test_data <- test_data %>%
	left_join(secciones_peligrosas %>% select(nombre_seccion, peligrosidad_seccion), by = "nombre_seccion")

train_data$nombre_seccion <- NULL
train_data$seccion <- NULL

validation_data$nombre_seccion <- NULL
validation_data$seccion <- NULL

test_data$nombre_seccion <- NULL
test_data$seccion <- NULL

print(train_data)
print(validation_data)
print(test_data)
```

### Reemplazo de Columna de Especie por Peligrosidad por Especie

```{r}
especies_peligrosas <- peligrosidad_encoding(train_data, "especie", "peligrosidad_especie")

train_data <- train_data %>%
    left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

validation_data <- validation_data %>%
    left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

test_data <- test_data %>%
    left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

train_data$especie <- NULL
validation_data$especie <- NULL
test_data$especie <- NULL

print(train_data)
print(validation_data)
print(test_data)
```


### Reemplazo de Columna de Diámetro por Peligrosidad por Diámetro

```{r}
diametro_peligroso <- peligrosidad_encoding(train_data, "diametro_tronco", "peligrosidad_diametro")

train_data <- train_data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

validation_data <- validation_data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

test_data <- test_data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

train_data$diametro_tronco <- NULL
validation_data$diametro_tronco <- NULL
test_data$diametro_tronco <- NULL

print(train_data)
print(validation_data)
print(test_data)
```

### Reemplazo de Columna de Altura por Peligrosidad por Altura

```{r}
altura_peligrosa <- peligrosidad_encoding(train_data, "altura", "peligrosidad_altura")

train_data <- train_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

validation_data <- validation_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

test_data <- test_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

train_data$altura <- NULL
validation_data$altura <- NULL
test_data$altura <- NULL

print(train_data)
print(validation_data)
print(test_data)
```

# Random Forest

# XGBoost

```{r}
train_x <- data.matrix(train_data %>% select(-inclinacion_peligrosa, -id))
train_y <- (as.numeric(as.character(train_data$inclinacion_peligrosa)))

validation_x <- data.matrix(validation_data %>% select(-inclinacion_peligrosa, -id))
validation_y <- (as.numeric(as.character(validation_data$inclinacion_peligrosa)))

test_x <- data.matrix(test_data %>% select(-id))

xgb_train <- xgb.DMatrix(data = as.matrix(train_x), label = train_y)
xgb_validation <- xgb.DMatrix(data = as.matrix(validation_x), label = validation_y)
xgb_test <- xgb.DMatrix(data = as.matrix(test_x))
```

```{r}
watchlist <- list(train = xgb_train, test = xgb_validation)

param <- list(booster = "gbtree",
              #  train the model to predict 0 or 1 instead of producing probabilities
              objective = "binary:logistic", #"binary:hinge", # predice 0 o 1 en vez de probabilidad
              eta = 0.1,
              # gamma = 1,
              max_depth = 3,
              # subsample = 0.8,
              # colsample_bytree = 0.8,
              scale_pos_weight = scale_pos_weight,  # para balancear las clases -> solo se puede usar con binary:logistic
              # weight = class_weights,
              eval_metric = "auc")

xgb_model <- xgb.train(param, xgb_train, nrounds = 500, early_stopping_rounds = 50,  watchlist)  # para  usarlos hace falta las rts de test (creo???)

var_imp <- xgb.importance(feature_names = colnames(train_x), model = xgb_model)
xgb.plot.importance(var_imp)

xgb_model
```

```{r}
prediction_xgb <- predict(xgb_model, xgb_test)

rorder <-rank(prediction_xgb, ties.method = "first")

threshold <- 0.1
ntop <- length(rorder) - as.integer(threshold * length(rorder))

prediction_xgb <- ifelse(rorder > ntop, 1, 0)

result_dataset <- data.frame(id = test_data$id, inclinacion_peligrosa = as.numeric(as.character(prediction_xgb)))
result_dataset$inclinacion_peligrosa <- as.factor(result_dataset$inclinacion_peligrosa)

print(result_dataset)

write.csv(result_dataset, "data/data-parte-b/submission_13.csv", row.names = FALSE)
```

