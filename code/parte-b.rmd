---
title: "Parte B"
output: html_document
author: "Micaela Del Longo @MicaKil"
---

# Librerías

```{r}
library(dplyr)
library(ggplot2)
library(lattice)
library(caret)
library(ROSE)
library(randomForest)
```


# Preparación de los Datos

## Eliminación de Columnas Innecesarias (i hope)

```{r}
data <- read.csv("data/data-parte-b/arbolado-mza-dataset.csv")
# remueve columnas innecesarias
data$ultima_modificacion <- NULL
data$area_seccion <- NULL

test_data <- read.csv("data/data-parte-b/arbolado-mza-dataset-test.csv")
test_data$ultima_modificacion <- NULL
test_data$area_seccion <- NULL
```

## Feature Engineering

```{r}
peligrosidad_encoding <- function(data, column, new_column) {
    peligrosidad <- data %>%
        dplyr::group_by(!!sym(column)) %>%
        dplyr::summarize(peligrosa_count = sum(inclinacion_peligrosa == 1), total_count = n()) %>%
        dplyr::mutate({{new_column}} := peligrosa_count / total_count)

    return(peligrosidad)
}
```

### Reemplazo de Columna de Especie por Peligrosidad por Especie

```{r}
especies_peligrosas <- peligrosidad_encoding(data, "especie", "peligrosidad_especie")

data <- data %>%
    left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

test_data <- test_data %>%
    left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

data$especie <- NULL
test_data$especie <- NULL
```

### Reemplazo de Columna de Sección por Peligrosidad por Sección

```{r}
secciones_peligrosas <- peligrosidad_encoding(data, "seccion", "peligrosidad_seccion")

data <- data %>%
	left_join(secciones_peligrosas %>% select(seccion, peligrosidad_seccion), by = "seccion")

test_data <- test_data %>%
	left_join(secciones_peligrosas %>% select(seccion, peligrosidad_seccion), by = "seccion")

data$nombre_seccion <- NULL
data$seccion <- NULL

test_data$nombre_seccion <- NULL
test_data$seccion <- NULL
```

### Reemplazo de Columna de Diámetro por Peligrosidad por Diámetro

```{r}
diametro_peligroso <- peligrosidad_encoding(data, "diametro_tronco", "peligrosidad_diametro")

data <- data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

test_data <- test_data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

data$diametro_tronco <- NULL
test_data$diametro_tronco <- NULL
```

### Reemplazo de Columna de Altura por Peligrosidad por Altura

```{r}
altura_peligrosa <- peligrosidad_encoding(data, "altura", "peligrosidad_altura")

data <- data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

test_data <- test_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

data$altura <- NULL
test_data$altura <- NULL
```

## Balanceo de Clases

### Cost Sensitive Learning

```{r}
class_distribution <- table(data$inclinacion_peligrosa)
class_probability <- class_distribution / sum(class_distribution)
class_weights <- class_distribution[2] / class_distribution
```

### UnderSampling

```{r}
data <- ovun.sample(inclinacion_peligrosa ~ ., data = data, method = "under", seed = 2023)$data  # default p = 0.5
```

### Oversampling y UnderSampling

```{r}
data <- ovun.sample(inclinacion_peligrosa ~ ., data = data, method = "both", seed = 2023)$data

#percentage_1 <- train_data %>% dplyr::filter(inclinacion_peligrosa == 1) %>% nrow() / nrow(train_data) * 100
```

### Oversampling

```{r}
#percent <- data %>% dplyr::filter(inclinacion_peligrosa == 1) %>% nrow() / nrow(data) * 100

data <- ovun.sample(inclinacion_peligrosa ~ ., data = data, method = "over", p = 0.25, seed = 2023)$data
# p = 0.25 es el porcentaje de la clase minoritaria que se quiere alcanzar
```

# Random Forest

## Modelo y Entrenamiento

```{r}
data$inclinacion_peligrosa <- factor(data$inclinacion_peligrosa)

formula <- inclinacion_peligrosa ~ circ_tronco_cm + lat + long + peligrosidad_especie + peligrosidad_diametro + peligrosidad_altura + peligrosidad_seccion
rf_model <- randomForest(formula,
                         data = data,
                         ntree = 600,
                         #mtry = 3,  # Number of variables randomly sampled at each split. Default values: for classification sqrt(p) and regression p/3
                         #classwt = class_probability,
                         importance = TRUE,
                         proximity = TRUE,
                         do.trace = TRUE
                         )
```

```{r}
print(rf_model)
varImpPlot(rf_model)
```

## Predicción y Envío

```{r}
predictions <- predict(rf_model, test_data)
predictions_numeric <- as.numeric(as.character(predictions)) # predictions es un factor, hay que pasarlo a numeric

print(predictions_numeric)
```

```{r}
result_dataset <- data.frame(id = test_data$id, inclinacion_peligrosa = predictions_numeric)

write.csv(result_dataset, "data/submissions/submission_18.csv", row.names = FALSE)
```


```{r}
sub5 <- read.csv("data/submissions/submission_5_71767.csv")
percent <- sum(sub5$inclinacion_peligrosa == 1) / nrow(sub5) * 100
print(percent)

percent_prediction <- sum(predictions_numeric == 1) / length(predictions_numeric) * 100
print(percent_prediction)
```
