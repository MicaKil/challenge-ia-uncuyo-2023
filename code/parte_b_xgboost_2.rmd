---
title: "Parte B"
output: html_document
author: "Micaela Del Longo @MicaKil"
---

### Comentario para fede
Uso definición de test y validation de Harpo. sorry :c

# Librerías

```{r}
library(dplyr)
library(ggplot2)
library(lattice)
library(caret)
library(ROSE)
library(xgboost)
```

# Preparación de los Datos

```{r}
data <- read.csv("data/data-parte-b/arbolado-mza-dataset.csv")
data$inclinacion_peligrosa <- factor(data$inclinacion_peligrosa)

data$ultima_modificacion <- NULL
data$area_seccion <- NULL

test_data <- read.csv("data/data-parte-b/arbolado-mza-dataset-test.csv")
test_data$ultima_modificacion <- NULL
test_data$area_seccion <- NULL
```

```{r}
class_distribution <- table(data$inclinacion_peligrosa)
scale_pos_weight <- class_distribution[2] / class_distribution[1]

class_weights <- 10000 / class_distribution
weight <- class_weights[data$inclinacion_peligrosa]  # vector de pesos para cada observación

data$weight <- weight
```

## Feature Engineering

```{r}
peligrosidad_encoding <- function(data, column, new_column) {
    peligrosidad <- data %>%
        dplyr::group_by(!!sym(column)) %>%
        dplyr::summarize(peligrosa_count = sum(inclinacion_peligrosa == 1), total_count = n()) %>%
        dplyr::mutate({{new_column}} := peligrosa_count / total_count)

    return(peligrosidad)
}
```

### Reemplazo de Columna de Especie por Peligrosidad por Especie

```{r}
especies_peligrosas <- peligrosidad_encoding(data, "especie", "peligrosidad_especie")

data <- data %>%
  left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

test_data <- test_data %>%
  left_join(especies_peligrosas %>% select(especie, peligrosidad_especie), by = "especie")

data$especie <- NULL
test_data$especie <- NULL

print(data)
print(test_data)
```

### Reemplazo de Columna de Sección por Peligrosidad por Sección

```{r}
secciones_peligrosas <- peligrosidad_encoding(data, "seccion", "peligrosidad_seccion")

data <- data %>%
	left_join(secciones_peligrosas %>% select(seccion, peligrosidad_seccion), by = "seccion")

test_data <- test_data %>%
	left_join(secciones_peligrosas %>% select(seccion, peligrosidad_seccion), by = "seccion")

data$nombre_seccion <- NULL
data$seccion <- NULL

test_data$nombre_seccion <- NULL
test_data$seccion <- NULL

print(data)
print(test_data)
```


### Reemplazo de Columna de Diámetro por Peligrosidad por Diámetro

```{r}
diametro_peligroso <- peligrosidad_encoding(data, "diametro_tronco", "peligrosidad_diametro")

data <- data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

test_data <- test_data %>%
	left_join(diametro_peligroso %>% select(diametro_tronco, peligrosidad_diametro), by = "diametro_tronco")

data$diametro_tronco <- NULL
test_data$diametro_tronco <- NULL

print(data)
print(test_data)
```

### Reemplazo de Columna de Altura por Peligrosidad por Altura

```{r}
altura_peligrosa <- peligrosidad_encoding(data, "altura", "peligrosidad_altura")

data <- data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

test_data <- test_data %>%
	left_join(altura_peligrosa %>% select(altura, peligrosidad_altura), by = "altura")

data$altura <- NULL
test_data$altura <- NULL

print(data)
print(test_data)
```

# XGBoost

```{r}
train_x <- data.matrix(data %>% select(-inclinacion_peligrosa, -id, -weight))
train_y <- (as.numeric(as.character(data$inclinacion_peligrosa)))

xgb_train <- xgb.DMatrix(data = train_x, label = train_y, weight = weight)
```

## Modelo

```{r}
watchlist <- list("train" = xgb_train)

param <- list(booster = "gbtree", # default
              objective = "binary:logistic", #"binary:hinge", # predice 0 o 1 en vez de probabilidad
              eta = 0.01,
              # gamma = 1,
              max_depth = 9,
              subsample = 0.9,
              # colsample_bytree = 0.8,
              scale_pos_weight = scale_pos_weight,  # para balancear las clases -> solo se puede usar con binary:logistic
              # weight = class_weights,
              eval_metric = "auc")

xgb_model <- xgb.train(param, xgb_train, nrounds = 3000, early_stopping_rounds = 100,  watchlist)  # para  usarlos hace falta las rts de test (creo???)

var_imp <- xgb.importance(feature_names = colnames(train_x), model = xgb_model)
xgb.plot.importance(var_imp)

xgb_model
```

## Predicción

```{r}
test_x <- data.matrix(test_data %>% select(-id))
xgb_test <- xgb.DMatrix(data = test_x)

prediction_xgb <- predict(xgb_model, xgb_test)

# rorder <-rank(prediction_xgb, ties.method = "first")
#
# threshold <- 0.15
# ntop <- length(rorder) - as.integer(threshold * length(rorder))
#
# prediction_xgb <- ifelse(rorder > ntop, 1, 0)
prediction_xgb <- ifelse(prediction_xgb > 0.2, 1, 0)

result_dataset <- data.frame(id = test_data$id, inclinacion_peligrosa = as.numeric(as.character(prediction_xgb)))
result_dataset$inclinacion_peligrosa <- as.factor(result_dataset$inclinacion_peligrosa)

print(result_dataset)

write.csv(result_dataset, "data/submissions/submission_16.csv", row.names = FALSE)
```

